<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oracle V2 - Calendrier des Pronostics</title>
    <style>
        :root { --main-bg: #1a1d22; --card-bg: #2b2f36; --border-color: #444952; --text-primary: #e0e0e0; --text-secondary: #a0a4ab; --accent-color: #3b82f6; --success: #22c55e; --fail: #ef4444; --pending: #f59e0b;
            --score-high: #22c55e; --score-medium: #f59e0b; --score-low: #f87171;
            --market-over: #c026d3; --market-under: #2563eb; --market-btts: #db2777; --market-dc: #16a34a; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; background-color: var(--main-bg); color: var(--text-primary); }
        .container { max-width: 1600px; margin: auto; padding: 20px; }
        header { text-align: center; margin-bottom: 30px; }
        .calendar-nav { display: flex; justify-content: center; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 30px; padding: 10px; background-color: var(--card-bg); border-radius: 12px; }
        .day-btn { padding: 10px 15px; cursor: pointer; background-color: transparent; border: 2px solid transparent; color: var(--text-secondary); font-size: 0.9em; text-align: center; border-radius: 8px; transition: all 0.2s; }
        .day-btn.active, .day-btn:hover { background-color: var(--accent-color); color: white; }
        .day-btn.past { border-color: #555; }
        .day-btn span { display: block; font-size: 1.2em; font-weight: bold; }
        .day-stats { font-size: 0.8em; margin-top: 4px; }
        .day-stats.success { color: var(--success); }
        .day-stats.fail { color: var(--fail); }
        #content-area h2 { text-align: center; font-size: 1.8em; margin-bottom: 20px; }
        .section-title { font-size: 1.4em; color: var(--accent-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        .profile-section { margin-bottom: 30px; }
        .ticket-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 20px; }
        .ticket { border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--card-bg); overflow: hidden; }
        .ticket-header { padding: 10px 15px; border-bottom: 1px solid var(--border-color); background-color: rgba(0,0,0,0.2); }
        .ticket-body { padding: 15px; }
        .match { display: grid; grid-template-columns: 1fr auto auto; align-items: center; gap: 15px; padding: 10px 0; border-bottom: 1px solid var(--border-color); font-size: 14px; }
        .match:last-child { border-bottom: none; }
        .match-info small { color: var(--text-secondary); }
        .bet-type { padding: 4px 8px; border-radius: 4px; color: white; font-weight: bold; font-size: 0.8em; }
        .confidence-score { font-weight: bold; padding: 4px 8px; border-radius: 4px; }
        #loader { text-align: center; padding: 20px; font-size: 1.2em; }
        .stats-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        .stats-table th, .stats-table td { padding: 12px; border: 1px solid var(--border-color); text-align: left; }
        .stats-table th { background-color: #333; }
        .status-accepted { color: var(--success); font-weight: bold; }
        .status-refused { color: var(--fail); font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <header><h1>Oracle V2</h1></header>
        <main>
            <div id="calendar-container" class="calendar-nav"></div>
            <div id="loader"><button id="analyze-btn" onclick="fetchAnalysis()">Lancer l'Analyse Initiale</button></div>
            <div id="performance-stats-container"></div>
            <div id="content-area"></div>
        </main>
    </div>

    <script>
        const API_DATA = { predictions: {}, backtest: {}, results: {}, stats: {} };
        let selectedDate = null;

        document.addEventListener('DOMContentLoaded', renderCalendar);

        function getFormattedDate(date) { return date.toISOString().split('T')[0]; }
        
        function renderCalendar() {
            const container = document.getElementById('calendar-container');
            container.innerHTML = '';
            const today = new Date();
            selectedDate = getFormattedDate(today);

            for (let i = -7; i <= 7; i++) {
                const date = new Date();
                date.setDate(today.getDate() + i);
                const dateString = getFormattedDate(date);
                const dayBtn = document.createElement('button');
                dayBtn.className = 'day-btn';
                dayBtn.dataset.date = dateString;
                dayBtn.onclick = () => selectDate(dateString);
                const dayName = date.toLocaleDateString('fr-FR', { weekday: 'short' });
                dayBtn.innerHTML = `${dayName}<span>${date.getDate()}</span><div class="day-stats" id="stats-${dateString}"></div>`;
                if (new Date(dateString) < new Date(getFormattedDate(today))) dayBtn.classList.add('past');
                if (dateString === selectedDate) dayBtn.classList.add('active');
                container.appendChild(dayBtn);
            }
        }

        function selectDate(dateString) {
            if (!API_DATA.predictions) return; 
            selectedDate = dateString;
            document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.day-btn[data-date="${dateString}"]`).classList.add('active');
            renderContentForDate(dateString);
        }

        async function fetchAnalysis() {
            document.getElementById('loader').innerHTML = '<p>Analyse complète en cours...</p>';
            try {
                const response = await fetch('/api/analyze');
                const data = await response.json();
                API_DATA.predictions = data.predictionData.tickets;
                API_DATA.backtest = data.backtestData.tickets;
                API_DATA.stats = data.backtestData.stats;
                document.getElementById('loader').style.display = 'none';
                
                renderPerformanceStats(data.globalMarketStats);
                
                await processBacktestResults();
                selectDate(selectedDate);
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('loader').innerHTML = '<p style="color: red;">Erreur durant l\'analyse.</p>';
            }
        }
        
        function renderPerformanceStats(stats) {
            const container = document.getElementById('performance-stats-container');
            let tableHtml = `<h3 class="section-title">Analyse de Performance des Marchés (7 derniers jours)</h3>
                                <table class="stats-table">
                                    <thead><tr><th>Marché</th><th>Total</th><th>Succès</th><th>Taux</th><th>Statut (>67%)</th></tr></thead>
                                    <tbody>`;
            const sortedStats = Object.entries(stats).sort((a, b) => b[1].total - a[1].total);
            for (const [betType, data] of sortedStats) {
                const rate = data.rate;
                const status = rate >= 67 ? '<span class="status-accepted">Accepté</span>' : '<span class="status-refused">Refusé</span>';
                tableHtml += `<tr><td>${betType}</td><td>${data.total}</td><td>${data.success}</td><td>${rate.toFixed(2)}%</td><td>${status}</td></tr>`;
            }
            tableHtml += '</tbody></table>';
            container.innerHTML = tableHtml;
        }

        async function processBacktestResults() {
            const allFixtureIds = new Set();
            Object.values(API_DATA.backtest).flat().forEach(ticket => ticket.picks.forEach(p => allFixtureIds.add(p.match.id)));

            if (allFixtureIds.size === 0) return;
            const response = await fetch('/api/check-results', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fixtureIds: [...allFixtureIds] })
            });
            API_DATA.results = await response.json();

            document.querySelectorAll('.day-btn.past').forEach(btn => {
                const date = btn.dataset.date;
                let dailyTotal = 0, dailySuccess = 0;
                for (const profileName in API_DATA.backtest) {
                    const ticketsForDate = API_DATA.backtest[profileName].filter(ticket => ticket.picks.some(p => p.match.date.startsWith(date)));
                    if (ticketsForDate.length > 0) {
                        dailyTotal += ticketsForDate.length;
                        ticketsForDate.forEach(ticket => {
                            if (isTicketSuccess(ticket)) dailySuccess++;
                        });
                    }
                }
                const statsDiv = document.getElementById(`stats-${date}`);
                if (dailyTotal > 0) {
                    statsDiv.textContent = `${dailySuccess} / ${dailyTotal}`;
                    statsDiv.className = `day-stats ${dailySuccess > 0 ? 'success' : 'fail'}`;
                }
            });
        }

        function renderContentForDate(dateString) {
            const container = document.getElementById('content-area');
            const formattedDate = new Date(dateString).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
            container.innerHTML = `<h2>Pronostics pour le ${formattedDate}</h2>`;
            
            const isPast = new Date(dateString) < new Date(getFormattedDate(new Date()));
            const dataToShow = isPast ? API_DATA.backtest : API_DATA.predictions;

            let contentFound = false;
            for (const profileName in dataToShow) {
                const allTicketsForProfile = dataToShow[profileName];
                const ticketsForDate = allTicketsForProfile.filter(ticket => ticket.picks.some(p => p.match.date.startsWith(dateString)));
                
                if (ticketsForDate.length > 0) {
                    contentFound = true;
                    let profileHtml = `<div class="profile-section"><h3 class="profile-title">${profileName} (${ticketsForDate.length} ticket${ticketsForDate.length > 1 ? 's' : ''})</h3><div class="ticket-container">`;
                    ticketsForDate.forEach(ticket => profileHtml += buildTicketHtml(ticket, profileName));
                    profileHtml += `</div></div>`;
                    container.innerHTML += profileHtml;
                }
            }
            if (!contentFound) container.innerHTML += '<p style="text-align: center;">Aucun ticket à afficher pour ce jour.</p>';
        }

        function buildTicketHtml(ticket, profileName) {
            let matchesHtml = '';
            const totalOdds = ticket.picks.reduce((acc, p) => acc * (p.odds || 1), 1);

            if (profileName.toLowerCase().includes('lingot')) {
                if (ticket.picks.length === 1 && (totalOdds < 1.5 || totalOdds > 1.9)) return '';
                if (ticket.picks.length > 1 && totalOdds > 2.3) return '';
            }
            if (profileName.toLowerCase().includes('jackpot') && totalOdds < 30) return '';
            
            ticket.picks.forEach(p => {
                const matchDate = new Date(p.match.date);
                const dateText = `${matchDate.toLocaleDateString('fr-FR')} - ${matchDate.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'})}`;
                let marketColor = 'var(--text-secondary)';
                if (p.betType.includes('Over')) marketColor = 'var(--market-over)';
                if (p.betType.includes('Under')) marketColor = 'var(--market-under)';
                if (p.betType.includes('BTTS')) marketColor = 'var(--market-btts)';
                if (p.betType.includes('Double Chance')) marketColor = 'var(--market-dc)';
                let scoreColor = 'var(--score-low)';
                if (p.score >= 95) scoreColor = 'var(--score-high)';
                else if (p.score >= 90) scoreColor = 'var(--score-medium)';

                matchesHtml += `<div class="match">
                    <div class="match-info"><strong>${p.match.home_team} vs ${p.match.away_team}</strong><br><small>${dateText}</small></div>
                    <div class="bet-type" style="background-color:${marketColor}">${p.betType} @${p.odds || 'N/A'}</div>
                    <div class="confidence-score" style="background-color:${scoreColor}">${p.score.toFixed(0)}%</div>
                </div>`;
            });

            return `<div class="ticket">
                        <div class="ticket-header">Cote Totale: <strong>${totalOdds.toFixed(2)}</strong></div>
                        <div class="ticket-body">${matchesHtml}</div>
                    </div>`;
        }
        
        function isTicketSuccess(ticket) {
            return ticket.picks.every(pick => {
                const result = API_DATA.results[pick.match.id];
                return result ? isPickSuccess(pick, result.home, result.away) === true : false;
            });
        }
        
        function isPickSuccess(pick, homeGoals, awayGoals) {
            if (homeGoals === null || awayGoals === null) return null;
            const favIsHome = pick.favoriteName === pick.match.home_team;
            const favWins = (favIsHome && homeGoals > awayGoals) || (!favIsHome && awayGoals > homeGoals);
            if (pick.betType.startsWith('Double Chance')) return favWins || homeGoals === awayGoals;
            if (pick.betType === 'BTTS') return homeGoals > 0 && awayGoals > 0;
            if (pick.betType === 'BTTS - Non') return homeGoals === 0 || awayGoals === 0;
            const totalGoals = homeGoals + awayGoals;
            if(pick.betType === 'Over 1.5') return totalGoals > 1.5;
            if(pick.betType === 'Under 1.5') return totalGoals < 1.5;
            if(pick.betType === 'Over 2.5') return totalGoals > 2.5;
            if(pick.betType === 'Under 2.5') return totalGoals < 2.5;
            if(pick.betType === 'Over 3.5') return totalGoals > 3.5;
            if(pick.betType === 'Under 3.5') return totalGoals < 3.5;
            return null;
        }
    </script>
</body>
</html>